name: Test & Quality Check

# main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ìžë™ ì‹¤í–‰
on:
  push:
    branches: [ main ]
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --run

      - name: Generate coverage report
        run: npm run test:coverage
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-${{ matrix.node-version }}
        continue-on-error: true

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check bundle size
        run: |
          echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|---------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_ORIGINAL=0
          TOTAL_GZIPPED=0

          for file in dist/assets/*.js; do
            if [ -f "$file" ]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
              GZIP=$(gzip -c "$file" | wc -c)
              NAME=$(basename "$file")

              SIZE_KB=$((SIZE / 1024))
              GZIP_KB=$((GZIP / 1024))

              TOTAL_ORIGINAL=$((TOTAL_ORIGINAL + SIZE))
              TOTAL_GZIPPED=$((TOTAL_GZIPPED + GZIP))

              echo "| $NAME | ${SIZE_KB} KB | ${GZIP_KB} KB |" >> $GITHUB_STEP_SUMMARY

              if [ $GZIP -gt 30720 ]; then
                echo "âš ï¸  Warning: $NAME exceeds 30KB gzipped" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          TOTAL_ORIGINAL_KB=$((TOTAL_ORIGINAL / 1024))
          TOTAL_GZIPPED_KB=$((TOTAL_GZIPPED / 1024))

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${TOTAL_ORIGINAL_KB} KB** | **${TOTAL_GZIPPED_KB} KB** |" >> $GITHUB_STEP_SUMMARY

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check licenses
        run: npx license-checker --summary
        continue-on-error: true
